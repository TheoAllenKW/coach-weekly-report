<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPC Weekly Reports - Complete System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #d4145a 0%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            color: #333;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #d4145a 0%, #c01050 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 20, 90, 0.4);
        }
        
        .tab-btn:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid #c3e6cb;
            font-weight: bold;
            text-align: center;
        }
        
        .success-message.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        .edit-banner {
            background-color: #cfe2ff;
            color: #084298;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid #b6d4fe;
        }
        
        .edit-banner.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            color: #d4145a;
            margin-bottom: 20px;
            font-size: 1.8em;
            background: #fff0f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #d4145a;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #d4145a 0%, #000000 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: scale(1.02);
        }
        
        .submit-btn:active {
            transform: scale(0.98);
        }
        
        /* Dashboard Styles */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #d4145a 0%, #000000 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .kpi-target {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #000;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-on-target {
            background: #d4edda;
            color: #155724;
        }
        
        .status-below {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .btn-edit {
            background: #0d6efd;
            color: white;
        }
        
        .btn-edit:hover {
            background: #0b5ed7;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #bb2d3b;
        }
        
        .btn-export {
            background: #198754;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: auto;
        }
        
        .btn-export:hover {
            background: #157347;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters > div {
            display: flex;
            flex-direction: column;
        }
        
        .filters label {
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .filters input, .filters select {
            padding: 8px 12px;
        }
        
        .report-timestamp {
            font-size: 0.85em;
        }
        
        .report-edited {
            color: #0d6efd;
            font-size: 0.8em;
            margin-top: 3px;
        }
        
        .report-edit-count {
            color: #6c757d;
            font-size: 0.75em;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä PPC Weekly Coaching Reports</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('submit')">üìù Complete Report</button>
            <button class="tab-btn" onclick="switchTab('dashboard')">üìä Director's Dashboard</button>
            <button class="tab-btn" onclick="switchTab('reports')">üìã All Reports</button>
        </div>
        
        <div id="successMessage" class="success-message"></div>
        
        <!-- COMPLETE REPORT TAB -->
        <div id="submitTab" class="tab-content active">
            <div class="card">
                <div id="editBanner" class="edit-banner">
                    <div>
                        <strong>‚úèÔ∏è Editing Report</strong>
                        <div id="editInfo" style="font-size: 0.9em; margin-top: 5px;"></div>
                    </div>
                    <button class="btn-cancel" onclick="cancelEdit()">Cancel Edit</button>
                </div>
                
                <form id="reportForm">
                    <h2>Basic Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="coachName">Coach Name *</label>
                            <input type="text" id="coachName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="weekOf">Week Of *</label>
                            <input type="date" id="weekOf" required>
                            <small style="color: #666;">Select the Sunday of the reporting week</small>
                        </div>
                    </div>
                    
                    <h2>Team Activity Metrics</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="appointments">Coaching Appointments Held *</label>
                            <input type="number" id="appointments" required min="0" value="0">
                            <small style="color: #666;">1-on-1 sessions completed</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="goalsInCommand">Clients with Goals in Command *</label>
                            <input type="number" id="goalsInCommand" required min="0" value="0">
                            <small style="color: #666;">Documented goals</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="reportedNumbers">Clients Who Reported Numbers *</label>
                            <input type="number" id="reportedNumbers" required min="0" value="0">
                            <small style="color: #666;">Submitted tracker</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="activityStandards">Clients Meeting Activity Standards *</label>
                            <input type="number" id="activityStandards" required min="0" value="0">
                            <small style="color: #666;">Minimum contacts</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="kwPlaybook">Clients Using KW Playbook *</label>
                            <input type="number" id="kwPlaybook" required min="0" value="0">
                            <small style="color: #666;">1-3 playbook strategies</small>
                        </div>
                    </div>
                    
                    <h2>Production Metrics</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="buyerContracts">Buyer Contracts Executed *</label>
                            <input type="number" id="buyerContracts" required min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="listingAgreements">Listing Agreements Executed *</label>
                            <input type="number" id="listingAgreements" required min="0" value="0">
                        </div>
                    </div>
                    
                    <h2>Additional Information</h2>
                    <div class="form-group">
                        <label for="clientsAtRisk">Clients at Risk</label>
                        <textarea id="clientsAtRisk" rows="2" placeholder="List any clients who may be at risk of leaving..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Weekly Notes & Observations</label>
                        <textarea id="notes" rows="3" placeholder="Share wins, challenges, coaching focus areas..."></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">Submit Weekly Report</button>
                </form>
            </div>
        </div>
        
        <!-- DIRECTOR'S DASHBOARD TAB -->
        <div id="dashboardTab" class="tab-content">
            <div class="card">
                <div class="filters">
                    <div>
                        <label>View Period:</label>
                        <select id="dashboardPeriod" onchange="updateDashboard()">
                            <option value="current">Current Week</option>
                            <option value="lastWeek">Last Week</option>
                            <option value="last4Weeks">Last 4 Weeks</option>
                            <option value="quarterly">Quarterly (Last 90 Days)</option>
                            <option value="ytd">Year to Date</option>
                        </select>
                    </div>
                </div>
                
                <h2>Key Performance Indicators</h2>
                <div class="kpi-grid" id="kpiCards"></div>
                
                <h2>Coach Performance</h2>
                <div class="table-container">
                    <table id="coachPerformanceTable">
                        <thead>
                            <tr>
                                <th>Coach</th>
                                <th style="text-align: center;">Appts</th>
                                <th style="text-align: center;">Goals</th>
                                <th style="text-align: center;">Reported</th>
                                <th style="text-align: center;">Activity</th>
                                <th style="text-align: center;">Playbook</th>
                                <th style="text-align: center;">Buyers</th>
                                <th style="text-align: center;">Listings</th>
                                <th style="text-align: center;">Total</th>
                                <th style="text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="coachPerformanceBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ALL REPORTS TAB -->
        <div id="reportsTab" class="tab-content">
            <div class="card">
                <div class="filters">
                    <div>
                        <label>Filter by Coach:</label>
                        <select id="coachFilter" onchange="loadAllReports()">
                            <option value="">All Coaches</option>
                        </select>
                    </div>
                    
                    <div>
                        <label>Date From:</label>
                        <input type="date" id="dateFrom" onchange="loadAllReports()">
                    </div>
                    
                    <div>
                        <label>Date To:</label>
                        <input type="date" id="dateTo" onchange="loadAllReports()">
                    </div>
                    
                    <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                </div>
                
                <h2>All Reports <span id="reportCount" style="color: #666; font-size: 0.9em;">(0)</span></h2>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date Submitted</th>
                                <th>Coach</th>
                                <th style="text-align: center;">Week Of</th>
                                <th style="text-align: center;">Appts</th>
                                <th style="text-align: center;">Goals</th>
                                <th style="text-align: center;">Reported</th>
                                <th style="text-align: center;">Activity</th>
                                <th style="text-align: center;">Playbook</th>
                                <th style="text-align: center;">Buyers</th>
                                <th style="text-align: center;">Listings</th>
                                <th style="text-align: center;">Total</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allReportsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let reports = [];
        let editingIndex = null;
        
        // Load reports from localStorage
        function loadReports() {
            const saved = localStorage.getItem('ppcReportsComplete');
            if (saved) {
                try {
                    reports = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading reports:', e);
                    reports = [];
                }
            }
            updateCoachFilter();
            loadAllReports();
            updateDashboard();
        }
        
        // Save reports to localStorage
        function saveReports() {
            localStorage.setItem('ppcReportsComplete', JSON.stringify(reports));
        }
        
        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'submit') {
                document.getElementById('submitTab').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else if (tabName === 'dashboard') {
                document.getElementById('dashboardTab').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                updateDashboard();
            } else if (tabName === 'reports') {
                document.getElementById('reportsTab').classList.add('active');
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                loadAllReports();
            }
        }
        
        // Handle form submit
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const report = {
                timestamp: editingIndex !== null ? reports[editingIndex].timestamp : new Date().toISOString(),
                coachName: document.getElementById('coachName').value,
                weekOf: document.getElementById('weekOf').value,
                appointments: parseInt(document.getElementById('appointments').value) || 0,
                goalsInCommand: parseInt(document.getElementById('goalsInCommand').value) || 0,
                reportedNumbers: parseInt(document.getElementById('reportedNumbers').value) || 0,
                activityStandards: parseInt(document.getElementById('activityStandards').value) || 0,
                kwPlaybook: parseInt(document.getElementById('kwPlaybook').value) || 0,
                buyerContracts: parseInt(document.getElementById('buyerContracts').value) || 0,
                listingAgreements: parseInt(document.getElementById('listingAgreements').value) || 0,
                totalAgreements: (parseInt(document.getElementById('buyerContracts').value) || 0) + 
                                (parseInt(document.getElementById('listingAgreements').value) || 0),
                clientsAtRisk: document.getElementById('clientsAtRisk').value,
                notes: document.getElementById('notes').value
            };
            
            if (editingIndex !== null) {
                // Editing existing report
                report.editHistory = reports[editingIndex].editHistory || [];
                report.editHistory.push({
                    editedAt: new Date().toISOString(),
                    editedBy: report.coachName,
                    originalTimestamp: reports[editingIndex].timestamp
                });
                report.lastEditedAt = new Date().toISOString();
                reports[editingIndex] = report;
                editingIndex = null;
                document.getElementById('editBanner').classList.remove('show');
                showSuccess('Report updated successfully!');
            } else {
                // New report
                reports.push(report);
                showSuccess('Report submitted successfully!');
            }
            
            saveReports();
            
            // Reset form
            e.target.reset();
            document.getElementById('weekOf').valueAsDate = new Date();
            document.getElementById('submitBtn').textContent = 'Submit Weekly Report';
            
            // Update other views
            updateCoachFilter();
            loadAllReports();
            updateDashboard();
            
            // Switch to reports tab
            switchTab('reports');
        });
        
        // Show success message
        function showSuccess(message) {
            const msg = document.getElementById('successMessage');
            msg.textContent = message;
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);
        }
        
        // Edit report
        function editReport(index) {
            editingIndex = index;
            const report = reports[index];
            
            // Populate form
            document.getElementById('coachName').value = report.coachName;
            document.getElementById('weekOf').value = report.weekOf;
            document.getElementById('appointments').value = report.appointments;
            document.getElementById('goalsInCommand').value = report.goalsInCommand;
            document.getElementById('reportedNumbers').value = report.reportedNumbers;
            document.getElementById('activityStandards').value = report.activityStandards;
            document.getElementById('kwPlaybook').value = report.kwPlaybook;
            document.getElementById('buyerContracts').value = report.buyerContracts;
            document.getElementById('listingAgreements').value = report.listingAgreements;
            document.getElementById('clientsAtRisk').value = report.clientsAtRisk || '';
            document.getElementById('notes').value = report.notes || '';
            
            // Show edit banner
            document.getElementById('editBanner').classList.add('show');
            document.getElementById('editInfo').innerHTML = 
                `Originally submitted: ${new Date(report.timestamp).toLocaleString()}<br>` +
                (report.editHistory ? `Previously edited ${report.editHistory.length} time(s)` : '');
            
            // Change button text
            document.getElementById('submitBtn').textContent = 'üíæ Save Changes';
            
            // Switch to submit tab
            switchTab('submit');
            window.scrollTo(0, 0);
        }
        
        // Cancel edit
        function cancelEdit() {
            editingIndex = null;
            document.getElementById('editBanner').classList.remove('show');
            document.getElementById('reportForm').reset();
            document.getElementById('weekOf').valueAsDate = new Date();
            document.getElementById('submitBtn').textContent = 'Submit Weekly Report';
        }
        
        // Delete report
        function deleteReport(index) {
            if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                reports.splice(index, 1);
                saveReports();
                loadAllReports();
                updateDashboard();
                updateCoachFilter();
            }
        }
        
        // Update coach filter dropdown
        function updateCoachFilter() {
            const filter = document.getElementById('coachFilter');
            const coaches = [...new Set(reports.map(r => r.coachName))].sort();
            filter.innerHTML = '<option value="">All Coaches</option>' +
                coaches.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        // Load all reports
        function loadAllReports() {
            const tbody = document.getElementById('allReportsBody');
            const coachFilter = document.getElementById('coachFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let filtered = reports.filter(r => {
                if (coachFilter && r.coachName !== coachFilter) return false;
                if (dateFrom && r.weekOf < dateFrom) return false;
                if (dateTo && r.weekOf > dateTo) return false;
                return true;
            });
            
            document.getElementById('reportCount').textContent = `(${filtered.length})`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">No reports found. Submit your first report above!</td></tr>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            tbody.innerHTML = filtered.map((report, idx) => {
                const originalIndex = reports.indexOf(report);
                const submittedDate = new Date(report.timestamp).toLocaleString();
                const weekDate = new Date(report.weekOf).toLocaleDateString();
                
                let timestampHTML = `<div class="report-timestamp">${submittedDate}</div>`;
                if (report.lastEditedAt) {
                    timestampHTML += `<div class="report-edited">‚úèÔ∏è Edited: ${new Date(report.lastEditedAt).toLocaleString()}</div>`;
                    if (report.editHistory && report.editHistory.length > 0) {
                        timestampHTML += `<div class="report-edit-count">(${report.editHistory.length} edit${report.editHistory.length > 1 ? 's' : ''})</div>`;
                    }
                }
                
                return `
                    <tr>
                        <td>${timestampHTML}</td>
                        <td><strong>${report.coachName}</strong></td>
                        <td style="text-align: center;">${weekDate}</td>
                        <td style="text-align: center;">${report.appointments}</td>
                        <td style="text-align: center;">${report.goalsInCommand}</td>
                        <td style="text-align: center;">${report.reportedNumbers}</td>
                        <td style="text-align: center;">${report.activityStandards}</td>
                        <td style="text-align: center;">${report.kwPlaybook}</td>
                        <td style="text-align: center;">${report.buyerContracts}</td>
                        <td style="text-align: center;">${report.listingAgreements}</td>
                        <td style="text-align: center;"><strong>${report.totalAgreements}</strong></td>
                        <td style="text-align: center;">
                            <div class="action-btns">
                                <button class="btn btn-edit" onclick="editReport(${originalIndex})">‚úèÔ∏è Edit</button>
                                <button class="btn btn-delete" onclick="deleteReport(${originalIndex})">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update dashboard
        function updateDashboard() {
            const period = document.getElementById('dashboardPeriod').value;
            const now = new Date();
            let filtered = [];
            
            if (period === 'current') {
                const currentWeekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                filtered = reports.filter(r => new Date(r.weekOf) >= currentWeekStart);
            } else if (period === 'lastWeek') {
                const lastWeekStart = new Date(now.setDate(now.getDate() - now.getDay() - 7));
                const lastWeekEnd = new Date(lastWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
                filtered = reports.filter(r => {
                    const date = new Date(r.weekOf);
                    return date >= lastWeekStart && date <= lastWeekEnd;
                });
            } else if (period === 'last4Weeks') {
                const fourWeeksAgo = new Date(now.setDate(now.getDate() - 28));
                filtered = reports.filter(r => new Date(r.weekOf) >= fourWeeksAgo);
            } else if (period === 'quarterly') {
                const ninetyDaysAgo = new Date(now.setDate(now.getDate() - 90));
                filtered = reports.filter(r => new Date(r.weekOf) >= ninetyDaysAgo);
            } else if (period === 'ytd') {
                const yearStart = new Date(now.getFullYear(), 0, 1);
                filtered = reports.filter(r => new Date(r.weekOf) >= yearStart);
            }
            
            // Calculate KPIs
            const kpis = {
                appointments: filtered.reduce((sum, r) => sum + r.appointments, 0),
                goalsInCommand: filtered.reduce((sum, r) => sum + r.goalsInCommand, 0),
                reportedNumbers: filtered.reduce((sum, r) => sum + r.reportedNumbers, 0),
                activityStandards: filtered.reduce((sum, r) => sum + r.activityStandards, 0),
                kwPlaybook: filtered.reduce((sum, r) => sum + r.kwPlaybook, 0),
                buyerContracts: filtered.reduce((sum, r) => sum + r.buyerContracts, 0),
                listingAgreements: filtered.reduce((sum, r) => sum + r.listingAgreements, 0),
                totalAgreements: filtered.reduce((sum, r) => sum + r.totalAgreements, 0)
            };
            
            // Render KPI cards
            const kpiData = [
                { label: 'Total Appointments', value: kpis.appointments, target: 80 },
                { label: 'Goals in Command', value: kpis.goalsInCommand, target: 60 },
                { label: 'Reported Numbers', value: kpis.reportedNumbers, target: 60 },
                { label: 'Activity Standards', value: kpis.activityStandards, target: 50 },
                { label: 'Using KW Playbook', value: kpis.kwPlaybook, target: 40 },
                { label: 'Buyer Contracts', value: kpis.buyerContracts, target: 15 },
                { label: 'Listing Agreements', value: kpis.listingAgreements, target: 10 },
                { label: 'Total Agreements', value: kpis.totalAgreements, target: 25 }
            ];
            
            document.getElementById('kpiCards').innerHTML = kpiData.map(kpi => `
                <div class="kpi-card">
                    <div class="kpi-label">${kpi.label}</div>
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-target">Target: ${kpi.target}</div>
                </div>
            `).join('');
            
            // Coach performance
            const coachData = {};
            filtered.forEach(report => {
                if (!coachData[report.coachName]) {
                    coachData[report.coachName] = {
                        appointments: 0,
                        goalsInCommand: 0,
                        reportedNumbers: 0,
                        activityStandards: 0,
                        kwPlaybook: 0,
                        buyerContracts: 0,
                        listingAgreements: 0,
                        totalAgreements: 0
                    };
                }
                coachData[report.coachName].appointments += report.appointments;
                coachData[report.coachName].goalsInCommand += report.goalsInCommand;
                coachData[report.coachName].reportedNumbers += report.reportedNumbers;
                coachData[report.coachName].activityStandards += report.activityStandards;
                coachData[report.coachName].kwPlaybook += report.kwPlaybook;
                coachData[report.coachName].buyerContracts += report.buyerContracts;
                coachData[report.coachName].listingAgreements += report.listingAgreements;
                coachData[report.coachName].totalAgreements += report.totalAgreements;
            });
            
            const tbody = document.getElementById('coachPerformanceBody');
            
            if (Object.keys(coachData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No data for selected period</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.keys(coachData).sort().map(coach => {
                const data = coachData[coach];
                
                // Calculate target based on period
                let target = 25;
                if (period === 'last4Weeks') target = 100;
                else if (period === 'quarterly') target = 325;
                else if (period === 'ytd') {
                    const weeksInYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    target = weeksInYear * 25;
                }
                
                let statusClass = 'status-critical';
                let statusText = '‚úó Critical';
                if (data.totalAgreements >= target) {
                    statusClass = 'status-on-target';
                    statusText = '‚úì On Target';
                } else if (data.totalAgreements >= target * 0.8) {
                    statusClass = 'status-below';
                    statusText = '‚ö† Below Target';
                }
                
                return `
                    <tr>
                        <td><strong>${coach}</strong></td>
                        <td style="text-align: center;">${data.appointments}</td>
                        <td style="text-align: center;">${data.goalsInCommand}</td>
                        <td style="text-align: center;">${data.reportedNumbers}</td>
                        <td style="text-align: center;">${data.activityStandards}</td>
                        <td style="text-align: center;">${data.kwPlaybook}</td>
                        <td style="text-align: center;">${data.buyerContracts}</td>
                        <td style="text-align: center;">${data.listingAgreements}</td>
                        <td style="text-align: center;"><strong>${data.totalAgreements}</strong></td>
                        <td style="text-align: center;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Export to CSV
        function exportToCSV() {
            const coachFilter = document.getElementById('coachFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let filtered = reports.filter(r => {
                if (coachFilter && r.coachName !== coachFilter) return false;
                if (dateFrom && r.weekOf < dateFrom) return false;
                if (dateTo && r.weekOf > dateTo) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                alert('No reports to export!');
                return;
            }
            
            const headers = [
                'Date Submitted', 'Coach', 'Week Of', 'Appointments', 'Goals in Command',
                'Reported Numbers', 'Activity Standards', 'KW Playbook', 'Buyer Contracts',
                'Listing Agreements', 'Total Agreements', 'Clients at Risk', 'Notes'
            ];
            
            const csv = [
                headers.join(','),
                ...filtered.map(r => [
                    `"${new Date(r.timestamp).toLocaleString()}"`,
                    `"${r.coachName}"`,
                    `"${new Date(r.weekOf).toLocaleDateString()}"`,
                    r.appointments,
                    r.goalsInCommand,
                    r.reportedNumbers,
                    r.activityStandards,
                    r.kwPlaybook,
                    r.buyerContracts,
                    r.listingAgreements,
                    r.totalAgreements,
                    `"${(r.clientsAtRisk || '').replace(/"/g, '""')}"`,
                    `"${(r.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PPC_Reports_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('weekOf').valueAsDate = new Date();
            loadReports();
        });
    </script>
</body>
</html>
